<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Multiplicación en AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #question {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <!-- Muestra la pregunta -->
  <div id="question"></div>
  <!-- Elemento de audio para el sonido de acierto -->
  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  
  <!-- Se cargan Three.js y ARButton -->
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.module.js';
    import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.138.0/examples/jsm/webxr/ARButton.js';

    let camera, scene, renderer;
    let correctAnswer;
    let answers = [];
    let hasCollided = false; // Bandera para evitar múltiples colisiones
    const questionDiv = document.getElementById('question');
    const collisionThreshold = 0.2; // Distancia en metros para considerar "colisión"

    // Inicializa la escena, genera la pregunta, crea los paneles de respuesta y arranca la animación
    init();
    generateQuestion();
    createAnswerObjects();
    animate();

    // Desbloquea el audio en dispositivos móviles tras el primer toque
    window.addEventListener('touchstart', function unlockAudio() {
      const audioEl = document.getElementById('successSound');
      audioEl.play().then(() => {
        audioEl.pause();
        audioEl.currentTime = 0;
      }).catch((e) => {
        console.error('Error unlocking audio:', e);
      });
    }, { once: true });

    // Genera una pregunta de multiplicación aleatoria y define la respuesta correcta
    function generateQuestion() {
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 10) + 1;
      correctAnswer = a * b;
      questionDiv.innerHTML = `¿Cuánto es ${a} x ${b}?`;
    }

    function init() {
      // Crear escena y cámara
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      // Configurar el render con fondo transparente para ver la cámara real
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      
      // Botón para iniciar la experiencia AR (necesario en WebXR)
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Luz ambiental para iluminar los objetos
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      light.position.set(0.5, 1, 0.25);
      scene.add(light);

      window.addEventListener('resize', onWindowResize, false);
    }

    // Ajusta el render al cambiar el tamaño de la ventana
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // Crea los paneles con las respuestas (incluye la respuesta correcta y tres incorrectas)
    function createAnswerObjects() {
      // Eliminar paneles previos
      answers.forEach(panel => scene.remove(panel));
      answers = [];

      // Genera tres respuestas incorrectas (números entre 1 y 100 que no sean iguales a la respuesta correcta)
      const wrongAnswers = new Set();
      while (wrongAnswers.size < 3) {
        let wrong = Math.floor(Math.random() * 100) + 1;
        if (wrong !== correctAnswer) wrongAnswers.add(wrong);
      }
      const answersArray = [correctAnswer, ...wrongAnswers];
      // Barajar las respuestas para ubicar aleatoriamente la correcta
      answersArray.sort(() => Math.random() - 0.5);

      // Distribuir los paneles en un arco horizontal a 0.8 m de la cámara (más separados)
      const radius = 0.8;
      const total = answersArray.length;
      const angleStart = -Math.PI / 4;
      const angleEnd = Math.PI / 4;

      answersArray.forEach((num, index) => {
        // Crear un canvas para dibujar el número en un panel pequeño
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 256;
        const context = canvas.getContext('2d');
        context.fillStyle = '#FFFFFF';
        context.fillRect(0, 0, canvas.width, canvas.height);
        // Tamaño de fuente reducido para panel pequeño
        context.font = 'Bold 25px Arial';
        context.fillStyle = '#000000';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        context.fillText(num, canvas.width / 2, canvas.height / 2);
        
        const texture = new THREE.CanvasTexture(canvas);
        const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
        // Tamaño del panel reducido (0.15 m x 0.15 m)
        const geometry = new THREE.PlaneGeometry(0.15, 0.15);
        const mesh = new THREE.Mesh(geometry, material);

        // Calcular el ángulo para ubicar cada panel en el arco
        let angle = total === 1 ? 0 : angleStart + (angleEnd - angleStart) * (index / (total - 1));
        const x = radius * Math.sin(angle);
        const z = - radius * Math.cos(angle);
        mesh.position.set(x, 0, z);
        mesh.userData = { answer: num };
        answers.push(mesh);
        scene.add(mesh);
      });
    }

    // Bucle de animación: en cada frame se comprueba si el móvil "colisiona" con alguno de los paneles
    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render() {
      renderer.render(scene, camera);

      // Obtener la posición actual de la cámara (móvil)
      const camPos = new THREE.Vector3();
      camera.getWorldPosition(camPos);

      // Recorrer cada panel y comprobar la distancia al móvil
      for (let panel of answers) {
        const panelPos = new THREE.Vector3();
        panel.getWorldPosition(panelPos);
        const distance = camPos.distanceTo(panelPos);

        if (distance < collisionThreshold && !hasCollided) {
          hasCollided = true;
          if (panel.userData.answer === correctAnswer) {
            // Reproduce el sonido de acierto y muestra mensaje de éxito
            document.getElementById('successSound').play().catch(e => console.error(e));
            alert("¡Correcto!");
          } else {
            alert("Incorrecto. Inténtalo de nuevo.");
          }
          // Tras unos segundos se regenera la pregunta y se reinicia la comprobación
          setTimeout(() => {
            generateQuestion();
            createAnswerObjects();
            hasCollided = false;
          }, 2000);
          break; // Solo se procesa una colisión a la vez
        }
      }
    }
  </script>
</body>
</html>
